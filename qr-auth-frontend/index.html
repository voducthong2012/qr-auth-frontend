<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X√°c Th·ª±c S·∫£n Ph·∫©m Ch√≠nh H√£ng</title>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f6f6f6;
      padding: 20px;
      text-align: center;
      margin: 0;
    }
    .qr-box {
      background: white;
      max-width: 500px;
      margin: 50px auto;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .status {
      font-size: 20px;
      margin: 20px 0;
      font-weight: bold;
    }
    .ok { color: green; }
    .warn { color: orange; }
    .fail { color: red; }
    small { color: #666; }
    .g-recaptcha { display: none; } /* ·∫®n n√∫t reCAPTCHA */
  </style>
</head>
<body>

  <div class="qr-box">
    <h2>üîç Ki·ªÉm tra tem ch·ªëng gi·∫£</h2>
    <div id="result" class="status">ƒêang ki·ªÉm tra m√£...</div>
    <div id="info"></div>
    <small>H·ªá th·ªëng x√°c th·ª±c t·∫°i <b>auth.quetmaqr.com</b></small>
  </div>

  <form id="recaptcha-form" action="#">
    <button class="g-recaptcha"
            data-sitekey="6LfEMYcrAAAAAM6mYcnHVs40OJ7zcf_S6PUoDE92"
            data-callback="onReCaptchaSuccess"
            data-size="invisible">
    </button>
  </form>

  <script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const resultEl = document.getElementById("result");
    const infoEl = document.getElementById("info");

    // T·ª± ƒë·ªông k√≠ch ho·∫°t reCAPTCHA khi trang t·∫£i xong
    window.onload = () => {
      if (!code) {
        resultEl.innerHTML = "‚ùå Kh√¥ng t√¨m th·∫•y m√£ QR trong li√™n k·∫øt.";
        resultEl.className = "status fail";
      } else {
        // ƒê·∫£m b·∫£o reCAPTCHA ƒë√£ s·∫µn s√†ng tr∆∞·ªõc khi click
        if (typeof grecaptcha !== 'undefined') {
            grecaptcha.ready(() => {
                document.querySelector(".g-recaptcha").click();
            });
        }
      }
    };

    // Callback ƒë∆∞·ª£c g·ªçi khi reCAPTCHA th√†nh c√¥ng
    function onReCaptchaSuccess(token) {
      if (!token) {
        resultEl.innerHTML = "‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c reCAPTCHA token.";
        resultEl.className = "status fail";
        return;
      }

      // G·ªçi API Edge Function c·ªßa b·∫°n
      fetch("https://uviqesqguuekioeqoxpj.supabase.co/functions/v1/verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          qrcode: code,
          location: "auth.quetmaqr.com",
          user_agent: navigator.userAgent,
          recaptcha_token: token
        })
      })
      .then(async res => {
         const data = await res.json();
         if (!res.ok) {
           resultEl.innerHTML = `‚ö†Ô∏è L·ªói: ${data.error || "Kh√¥ng r√µ nguy√™n nh√¢n."}`;
           resultEl.className = "status fail";
           return;
         }

         const item = data.data;
         const isFirstScan = !item.last_scanned_at;
         const scanCount = (item.scan || 0) + 1; // C·∫≠p nh·∫≠t s·ªë l·∫ßn qu√©t ƒë·ªÉ hi·ªÉn th·ªã ƒë√∫ng

         resultEl.innerHTML = isFirstScan
           ? "‚úÖ S·∫£n ph·∫©m ch√≠nh h√£ng. Tem ch∆∞a t·ª´ng ƒë∆∞·ª£c qu√©t."
           : "‚ö†Ô∏è M√£ ƒë√£ t·ª´ng ƒë∆∞·ª£c x√°c minh tr∆∞·ªõc ƒë√≥.";
         resultEl.className = isFirstScan ? "status ok" : "status warn";

         infoEl.innerHTML = `
           <p>T√™n s·∫£n ph·∫©m: <b>${item.Product_name || "Kh√¥ng r√µ"}</b></p>
           <p>S·ªë l√¥: <b>${item.lot_no || "Kh√¥ng r√µ"}</b></p>
           <p>Ng√†y s·∫£n xu·∫•t: <b>${item.manufactured_at ? new Date(item.manufactured_at).toLocaleDateString("vi-VN") : "Ch∆∞a c√≥"}</b></p>
           <p>Ng√†y x√°c th·ª±c g·∫ßn nh·∫•t: <b>${item.last_scanned_at ? new Date(item.last_scanned_at).toLocaleDateString("vi-VN") : "Ch∆∞a qu√©t l·∫ßn n√†o"}</b></p>
           <p>S·ªë l·∫ßn qu√©t: <b>${scanCount}</b></p>
         `;
      })
      .catch(() => {
        resultEl.innerHTML = "‚ö†Ô∏è L·ªói k·∫øt n·ªëi: kh√¥ng th·ªÉ truy c·∫≠p h·ªá th·ªëng.";
        resultEl.className = "status fail";
      });
    }
  </script>

</body>
</html>