<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X√°c Th·ª±c S·∫£n Ph·∫©m Ch√≠nh H√£ng</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f6f6f6; padding: 20px; text-align: center; margin: 0; }
    .qr-box { background: white; max-width: 500px; margin: 50px auto; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .status { font-size: 20px; margin: 20px 0; font-weight: bold; }
    .ok { color: green; }
    .warn { color: orange; }
    .fail { color: red; }
    small { color: #666; }
    #info p { margin: 8px 0; text-align: left; }
    .g-recaptcha { display: none; }
  </style>
</head>
<body>

  <div class="qr-box">
    <h2>üîç Ki·ªÉm tra tem ch·ªëng gi·∫£</h2>
    <div id="result" class="status">ƒêang ki·ªÉm tra m√£...</div>
    <div id="info"></div>
    <small>H·ªá th·ªëng x√°c th·ª±c t·∫°i <b>auth.quetmaqr.com</b></small>
  </div>

  <form id="recaptcha-form" action="#">
    <button class="g-recaptcha"
            data-sitekey="6Lcxq5wrAAAAAIttEdELGqn0J4b1DrKRu_YynLHw"
            data-callback="onReCaptchaSuccess"
            data-size="invisible">
    </button>
  </form>

  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const resultEl = document.getElementById("result");
    const infoEl = document.getElementById("info");

    // H√†m n√†y s·∫Ω ƒë∆∞·ª£c g·ªçi b·ªüi script c·ªßa Google khi n√≥ ƒë√£ s·∫µn s√†ng
    function onReCaptchaLoad() {
      if (!code) {
        resultEl.innerHTML = "‚ùå Kh√¥ng t√¨m th·∫•y m√£ QR trong li√™n k·∫øt.";
        resultEl.className = "status fail";
      } else {
        grecaptcha.ready(() => {
          document.querySelector(".g-recaptcha").click();
        });
      }
    }

    // G√°n h√†m callback v√†o window ƒë·ªÉ script reCAPTCHA c√≥ th·ªÉ g·ªçi
    window.onReCaptchaLoad = onReCaptchaLoad;

    function onReCaptchaSuccess(token) {
      if (!token) {
        resultEl.innerHTML = "‚ùå L·ªói x√°c th·ª±c reCAPTCHA.";
        resultEl.className = "status fail";
        return;
      }

      fetch("https://uviqesqguuekioeqoxpj.supabase.co/functions/v1/verify-auth", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          qrcode: code,
          location: "auth.quetmaqr.com",
          user_agent: navigator.userAgent,
          recaptcha_token: token
        })
      })
      .then(async res => {
         const data = await res.json();
         if (!res.ok) {
           resultEl.innerHTML = `‚ö†Ô∏è L·ªói: ${data.error || "Kh√¥ng r√µ nguy√™n nh√¢n."}`;
           resultEl.className = "status fail";
           return;
         }

         const item = data.data;
         const scanCount = item.scan;
         const isFirstScan = !item.scanned_at || (scanCount === 1);

         resultEl.innerHTML = isFirstScan
           ? "‚úÖ S·∫£n ph·∫©m ch√≠nh h√£ng. Tem ƒë∆∞·ª£c qu√©t l·∫ßn ƒë·∫ßu."
           : "‚ö†Ô∏è M√£ ƒë√£ t·ª´ng ƒë∆∞·ª£c x√°c minh tr∆∞·ªõc ƒë√≥.";
         resultEl.className = isFirstScan ? "status ok" : "status warn";

         infoEl.innerHTML = `
           <p>T√™n s·∫£n ph·∫©m: <b>${item.Product_name || "Kh√¥ng r√µ"}</b></p>
           <p>S·ªë l√¥: <b>${item.lot_no || "Kh√¥ng r√µ"}</b></p>
           <p>S·ªë l·∫ßn qu√©t: <b>${scanCount}</b></p>
           <p>Ng√†y qu√©t ƒë·∫ßu ti√™n: <b>${item.scanned_at ? new Date(item.scanned_at).toLocaleDateString("vi-VN") : 'V·ª´a qu√©t'}</b></p>
         `;
      })
      .catch(() => {
        resultEl.innerHTML = "‚ö†Ô∏è L·ªói k·∫øt n·ªëi: kh√¥ng th·ªÉ truy c·∫≠p h·ªá th·ªëng.";
        resultEl.className = "status fail";
      });
    }

    // Th√™m callback v√†o URL c·ªßa script reCAPTCHA
    const recaptchaScript = document.createElement('script');
    recaptchaScript.src = 'https://www.google.com/recaptcha/api.js?onload=onReCaptchaLoad&render=explicit';
    recaptchaScript.async = true;
    recaptchaScript.defer = true;
    document.head.appendChild(recaptchaScript);
  </script>

</body>
</html>
