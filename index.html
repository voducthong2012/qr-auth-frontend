<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>X√°c Th·ª±c S·∫£n Ph·∫©m Ch√≠nh H√£ng</title>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f6f6f6; padding: 20px; text-align: center; margin: 0; }
    .qr-box { background: white; max-width: 500px; margin: 50px auto; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .status { font-size: 20px; margin: 20px 0; font-weight: bold; }
    .ok { color: green; }
    .warn { color: orange; }
    .fail { color: red; }
    small { color: #666; }
    #info p { margin: 8px 0; text-align: left; }
    .g-recaptcha { display: none; }
  </style>
</head>
<body>

  <div class="qr-box">
    <h2>üîç Ki·ªÉm tra tem ch·ªëng gi·∫£</h2>
    <div id="result" class="status">ƒêang ki·ªÉm tra m√£...</div>
    <div id="info"></div>
    <small>H·ªá th·ªëng x√°c th·ª±c t·∫°i <b>auth.quetmaqr.com</b></small>
  </div>

  <form id="recaptcha-form" action="#">
    <button class="g-recaptcha"
            data-sitekey="6Lcxq5wrAAAAAIttEdELGqn0J4b1DrKRu_YynLHw"
            data-callback="onReCaptchaSuccess"
            data-size="invisible">
    </button>
  </form>

  <script>
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const resultEl = document.getElementById("result");
    const infoEl = document.getElementById("info");

    // H√ÄM M·ªöI: C·ªông 7 ti·∫øng v√† ƒë·ªãnh d·∫°ng gi·ªù Vi·ªát Nam
    function formatToVietnamTime(utcDateString) {
      if (!utcDateString) return 'V·ª´a xong';
      // T·∫°o ng√†y t·ª´ chu·ªói UTC v√† c·ªông th√™m 7 gi·ªù
      const date = new Date(new Date(utcDateString).getTime() + 7 * 60 * 60 * 1000);
      
      // L·∫•y c√°c th√†nh ph·∫ßn ng√†y/gi·ªù t·ª´ ng√†y ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh
      const day = String(date.getUTCDate()).padStart(2, '0');
      const month = String(date.getUTCMonth() + 1).padStart(2, '0'); // Th√°ng b·∫Øt ƒë·∫ßu t·ª´ 0
      const year = date.getUTCFullYear();
      const hours = String(date.getUTCHours()).padStart(2, '0');
      const minutes = String(date.getUTCMinutes()).padStart(2, '0');
      const seconds = String(date.getUTCSeconds()).padStart(2, '0');
      
      return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
    }

    window.onload = () => {
      if (!code) {
        resultEl.innerHTML = "‚ùå Kh√¥ng t√¨m th·∫•y m√£ QR trong li√™n k·∫øt.";
        resultEl.className = "status fail";
      } else {
        if (typeof grecaptcha !== 'undefined') {
            grecaptcha.ready(() => {
                document.querySelector(".g-recaptcha").click();
            });
        }
      }
    };

    function onReCaptchaSuccess(token) {
      if (!token) {
        resultEl.innerHTML = "‚ùå L·ªói x√°c th·ª±c reCAPTCHA.";
        resultEl.className = "status fail";
        return;
      }

      fetch("https://uviqesqguuekioeqoxpj.supabase.co/functions/v1/verify-auth", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          qrcode: code,
          location: "auth.quetmaqr.com",
          user_agent: navigator.userAgent,
          recaptcha_token: token
        })
      })
      .then(async res => {
         const data = await res.json();
         if (!res.ok) {
           resultEl.innerHTML = `‚ö†Ô∏è L·ªói: ${data.error || "Kh√¥ng r√µ nguy√™n nh√¢n."}`;
           resultEl.className = "status fail";
           return;
         }

         const item = data.data;
         const scanCount = item.scan;
         const isFirstScan = !item.scanned_at || (scanCount === 1);

         resultEl.innerHTML = isFirstScan
           ? "‚úÖ S·∫£n ph·∫©m ch√≠nh h√£ng. Tem ƒë∆∞·ª£c qu√©t l·∫ßn ƒë·∫ßu."
           : "‚ö†Ô∏è M√£ ƒë√£ t·ª´ng ƒë∆∞·ª£c x√°c minh tr∆∞·ªõc ƒë√≥.";
         resultEl.className = isFirstScan ? "status ok" : "status warn";

         infoEl.innerHTML = `
           <p>T√™n s·∫£n ph·∫©m: <b>${item.Product_name || "Kh√¥ng r√µ"}</b></p>
           <p>S·ªë l√¥: <b>${item.lot_no || "Kh√¥ng r√µ"}</b></p>
           <p>S·ªë l·∫ßn qu√©t: <b>${scanCount}</b></p>
           <p>L·∫ßn qu√©t ƒë·∫ßu ti√™n: <b>${formatToVietnamTime(item.scanned_at)}</b></p>
           <p>L·∫ßn qu√©t g·∫ßn nh·∫•t: <b>${formatToVietnamTime(item.last_scanned_at)}</b></p>
         `;
      })
      .catch(() => {
        resultEl.innerHTML = "‚ö†Ô∏è L·ªói k·∫øt n·ªëi: kh√¥ng th·ªÉ truy c·∫≠p h·ªá th·ªëng.";
        resultEl.className = "status fail";
      });
    }
  </script>

</body>
</html>
